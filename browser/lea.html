<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 100%;">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.staticfile.org/echarts/5.2.2/echarts.min.js"></script>
    <script src="lea.js"></script>
    <script src="jparse.js"></script>
    <title>GrammarParser</title>
</head>
<body style="width: 100%; height: 100%;">
<div id="treeChart" style="width: 100%; height: 100%;"></div>
<label for="grammar">Grammar</label>
<br>
<div id="str" style="display: none;">
    import os;
    import sys;

    class Main {
        val uid: int;

        private val type: string;

        def main() {
            var x: int = 12;
            var s: string = "text";
            s = "another text";
            s = "text_" + x;
            s = getName();
            s = makeName(x);
            Main.method01();
            1 + 32;
            add(s, x2, x3, 3+ x4);
        }
    }
</div>
<textarea id="grammar" cols="150" rows="100" spellcheck="false">
 root
    : start
    ;

start
    : moduleDeclare
    | moduleDeclare classesDefine
    | classesDefine
    ;

moduleDeclare
    : moduleDeclare IMPORT IDENTIFIER SEMI
    | IMPORT IDENTIFIER SEMI
    ;

    classesDefine
    : classesDefine classDefine
    | classDefine
    ;

classDefine
    : CLASS IDENTIFIER LB RB
    | CLASS IDENTIFIER LB classMemberDefine RB
    ;

classMemberDefine
    : classMemberDefine memberDefine
    | memberDefine
    ;

memberDefine
    : limitedMemberDefine
    | PRIVATE limitedMemberDefine
    ;

limitedMemberDefine
    : methodDefine
    | variableDefine
    ;

methodDefine
    : DEF IDENTIFIER LP RP LB RB
    | DEF IDENTIFIER LP RP LB codeDefine RB
    ;

variableDefine
    : VAL IDENTIFIER COLON IDENTIFIER SEMI
    | VAR IDENTIFIER COLON IDENTIFIER SEMI
    ;

codeDefine
    : codeDefine codeImplement
    | codeImplement
    ;

codeImplement
    : rv SEMI
    | VAR IDENTIFIER COLON IDENTIFIER SEMI
    | VAR IDENTIFIER COLON IDENTIFIER EQ rv SEMI
    | VAL IDENTIFIER COLON IDENTIFIER SEMI
    | VAL IDENTIFIER COLON IDENTIFIER EQ rv SEMI
    ;

rv
    : rvTripleValue
    | rvTripleValue EQ rvTripleValue
    ;

rvTripleValue
    : rvOrValue QM rvOrValue COLON rvOrValue
    | rvOrValue
    ;

rvOrValue:
    : rvOrValue OR rvAndValue
    | rvAndValue
    ;

rvAndValue
    : rvAndValue AND rvPlusSubValue
    | rvPlusSubValue
    ;

rvPlusSubValue
    : rvPlusSubValue PLUS rvMulDivValue
    | rvPlusSubValue SUB  rvMulDivValue
    | rvMulDivValue
    ;

rvMulDivValue
    : rvMulDivValue MUL rvNotValue
    | rvMulDivValue DIV rvNotValue
    | rvMulDivValue MOD rvNotValue
    | rvNotValue
    ;

rvNotValue
    : NOT rvValue
    | rvValue
    ;

rvValue
    : rvArrayValue
    | rvBasicValue
    | LP rv RP
    ;

rvArrayValue
    : rvArrayValue LSB rv RSB
    | rvAccessing
    ;

rvAccessing
    : rvAccessing DOT rvInvoking
    | rvInvoking
    ;

rvInvoking
    : rvInvoking LP RP
    | rvInvoking LP argsList RP
    | IDENTIFIER
    ;

rvBasicValue
    : NUMBER
    ;

argsList
    : argsList COMMA arg
    | arg
    ;

arg
    : rv
    ;
</textarea>
<script type="text/javascript">
    let tree;
    function main() {
        console.info(">> parser running...");
        let strFromHtml = document.getElementById('str').innerText;
        let grammarFromHtml = document.getElementById('grammar').value;
        console.info(grammarFromHtml);
        // let str     = "show xxx when a = 12 and (b != -9.09 or c < -74) or (d = 43.00 and e != \"hello \\\"oh\")";
        // let words   = "skip: ^[ ]\n" +
        //     "FIELD: ^[a-zA-Z_][a-zA-Z0-9_]*\n" +
        //     "SHOW: ^(show|SHOW)\n" +
        //     "WHEN: ^(when|WHEN)\n" +
        //     "AND: ^(and|AND)\n" +
        //     "OR: ^(or|OR)\n" +
        //     "LP: ^\\(\n" +
        //     "RP: ^\\)\n" +
        //     "OP: ^(=|!=|>=|>|<=|<)\n" +
        //     "VALUE: ^(((-)?([0-9]+\\.)?[0-9]+)|('((\\\\')|[^'])*')|(\"((\\\\\")|[^\"])*\"))";
        // let grammar = "start: SHOW FIELD WHEN expr;\n" +
        //     "expr: expr OR andExpr | andExpr;\n" +
        //     "andExpr: andExpr AND atom | atom;\n" +
        //     "atom: LP expr RP | FIELD OP VALUE;";
        let lexer   = Grammar.lexer(words);
        // let
            tree    = Grammar.parser(grammarFromHtml);
        tree.printGrammar();
        try {
            tree.parse(strFromHtml, "start", lexer);
        } catch (e) {
            console.error(e);
        }
        console.info(">> isOver: " + tree.isOver());
        let data = tree.getTreeJson();
        tree.listen({
            enter_start: function (node) {console.info(">> enter start: " + node.getUid());},
            exit_start : function (node) {console.info(">> exit start: "  + node.getUid());},
            enter_expr : function (node) {console.info(">> enter expr: "  + node.getUid());},
            exit_expr  : function (node) {console.info(">> exit expr: "   + node.getUid());},
            enter_atom : function (node) {console.info(">> enter atom: "  + node.getUid());},
            exit_atom  : function (node) {console.info(">> exit atom: "   + node.getUid());},
        });
        tree.walkTree(tree.getTree());
        console.info(">>  depth: " + tree.getDepth());
        drawTree(data, tree.getDepth());
    }

    function drawTree(data, depth) {
        let chartDom = document.getElementById('treeChart');
        let myChart = echarts.init(chartDom);
        let option;
        myChart.showLoading();
        myChart.hideLoading();
        data.children.forEach(function (datum, index) {
            index % 2 === 0 && (datum.collapsed = true);
        });
        myChart.setOption(
            (option = {
                tooltip: {
                    trigger: 'item',
                    triggerOn: 'mousemove'
                },
                series: [
                    {
                        type: 'tree',
                        data: [data],
                        top: '1%',
                        left: '7%',
                        bottom: '1%',
                        right: '7%',
                        symbolSize: 7,
                        // orient: 'vertical',
                        label: {
                            position: 'left',
                            verticalAlign: 'middle',
                            align: 'right',
                            // rotate: 90,
                            fontSize: 12
                        },
                        leaves: {
                            label: {
                                position: 'right',
                                verticalAlign: 'middle',
                                // rotate: 0,
                                align: 'left'
                            }
                        },
                        emphasis: {
                            focus: 'descendant'
                        },
                        initialTreeDepth: 20,
                        expandAndCollapse: true,
                        animationDuration: 550,
                        animationDurationUpdate: 750
                    }
                ]
            })
        );
        option && myChart.setOption(option);
    }

    main();
</script>
</body>
</html>