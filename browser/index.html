<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.staticfile.org/echarts/5.2.2/echarts.min.js"></script>
    <script src="GrammarParser.js"></script>
    <title>GrammarParser</title>
</head>
<body>
    <div id="treeChart" style="width: 800px; height: 400px;"></div>
    <script type="text/javascript">
        function main() {
            console.info(">> parser running...");
            let str     = "show xxx when a = 12 and (b != 9 and c < 74)";
            let words   = "skip: ^[ ]\nFIELD: ^[a-zA-Z_][a-zA-Z0-9_]*\nSHOW: ^(show|SHOW)\n\nWHEN: ^(when|WHEN)\nAND: ^and\nLP: ^\\(\nRP: ^\\)\nOP: ^(=|!=|>|>=|<|<=)\nVALUE: ^[0-9]+";
            let grammar = "start: SHOW FIELD WHEN expr;\nexpr: expr AND atom | atom;\natom: LP expr RP | FIELD OP VALUE";
            let lexer   = Grammar.lexer(words);
            let tree    = Grammar.parser(grammar);
            tree.parse(str, "start", lexer);
            console.info(">> isOver: " + tree.isOver());
            // console.info(">> build tree ...");
            // console.info(">> print tree :");
            // tree.printTree(tree.getTree());
            let data = tree.getTreeJson();
            drawTree(data);
            tree.listen({
                enter_start: function (node) {console.info(">> enter start: " + node.getUid());},
                exit_start : function (node) {console.info(">> exit start: "  + node.getUid());},
                enter_expr : function (node) {console.info(">> enter expr: "  + node.getUid());},
                exit_expr  : function (node) {console.info(">> exit expr: "   + node.getUid());},
                enter_atom : function (node) {console.info(">> enter atom: "  + node.getUid());},
                exit_atom  : function (node) {console.info(">> exit atom: "   + node.getUid());},
            });
            tree.walkTree(tree.getTree());
        }

        function drawTree(data) {
            let chartDom = document.getElementById('treeChart');
            let myChart = echarts.init(chartDom);
            let option;
            myChart.showLoading();
            myChart.hideLoading();
            data.children.forEach(function (datum, index) {
                index % 2 === 0 && (datum.collapsed = true);
            });
            myChart.setOption(
                (option = {
                    tooltip: {
                        trigger: 'item',
                        triggerOn: 'mousemove'
                    },
                    series: [
                        {
                            type: 'tree',
                            data: [data],
                            top: '1%',
                            left: '7%',
                            bottom: '1%',
                            right: '20%',
                            symbolSize: 7,
                            // orient: 'vertical',
                            label: {
                                position: 'left',
                                verticalAlign: 'middle',
                                align: 'right',
                                // rotate: 90,
                                fontSize: 12
                            },
                            leaves: {
                                label: {
                                    position: 'right',
                                    verticalAlign: 'middle',
                                    // rotate: 0,
                                    align: 'left'
                                }
                            },
                            emphasis: {
                                focus: 'descendant'
                            },
                            initialTreeDepth: 4,
                            expandAndCollapse: true,
                            animationDuration: 550,
                            animationDurationUpdate: 750
                        }
                    ]
                })
            );
            option && myChart.setOption(option);
        }

        main();
    </script>
</body>
</html>